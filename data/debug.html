<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XY-SK120 Diagnostics</title>
    <style>
        /* Minimal styling that won't conflict with other styles */
        body {
            font-family: monospace;
            margin: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .debug-panel {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #fff;
        }
        h1, h2 {
            color: #2980b9;
        }
        pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            border: 1px solid #ddd;
        }
        button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        button:hover {
            background-color: #3498db;
        }
        .status-ok {
            color: green;
        }
        .status-error {
            color: red;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        .dark-mode {
            background-color: #222;
            color: #eee;
        }
        .dark-mode .debug-panel {
            background-color: #333;
            border-color: #555;
        }
        .dark-mode pre {
            background-color: #444;
            border-color: #555;
            color: #eee;
        }
        .dark-mode h1, .dark-mode h2 {
            color: #3498db;
        }
        .dark-mode th, .dark-mode td {
            border-color: #555;
        }
        .iframe-container {
            width: 100%;
            height: 400px;
            margin-bottom: 15px;
            display: none;
            border: 1px solid #ccc;
            position: relative;
        }
        
        #app-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .mode-toggles {
            margin-bottom: 10px;
        }
        
        .nav-links {
            margin-top: 15px;
        }
        
        .nav-links a {
            color: #2980b9;
            text-decoration: none;
            margin-right: 15px;
        }
        
        .nav-links a:hover {
            text-decoration: underline;
        }
        
        .dark-mode .nav-links a {
            color: #3498db;
        }
        
        .hidden {
            display: none;
        }
        
        .status-message {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #2980b9;
        }
        
        .dark-mode .status-message {
            background-color: #333;
            color: #eee;
        }
        
        .iframe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .loading-spinner {
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 5px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>XY-SK120 Diagnostic Interface</h1>
    <p>This page provides diagnostic information about the XY-SK120 web interface.</p>
    
    <div class="nav-links">
        <a href="index.html">Return to Main App</a>
        <a href="fallback.html">Go to Fallback UI</a>
    </div>
    
    <div class="status-message" id="status-message">
        Running in standalone mode. For complete DOM element checking, use "Load Main App in Frame" button.
    </div>
    
    <div class="debug-panel">
        <h2>Display Options</h2>
        <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
        <button onclick="location.reload()">Refresh Page</button>
        <button onclick="clearLog()">Clear Console</button>
    </div>
    
    <div class="debug-panel">
        <h2>DOM Elements Check</h2>
        
        <div class="mode-toggles">
            <button onclick="toggleIframeMode(true)">Load Main App in Frame</button>
            <button onclick="toggleIframeMode(false)">Standalone Mode</button>
        </div>
        
        <div class="iframe-container" id="iframe-container">
            <div class="iframe-overlay" id="iframe-overlay">
                <div class="loading-spinner"></div>
                <div>Loading main application...</div>
            </div>
            <iframe id="app-iframe" src="about:blank" sandbox="allow-same-origin allow-scripts"></iframe>
        </div>
        
        <button onclick="recheckElements()">Check DOM Elements</button>
        
        <table id="elements-table">
            <tr>
                <th>Element ID</th>
                <th>Present</th>
            </tr>
            <!-- Will be populated by script -->
        </table>
    </div>
    
    <div class="debug-panel">
        <h2>Module Loading Status</h2>
        <table id="module-table">
            <tr>
                <th>Module</th>
                <th>Status</th>
            </tr>
            <!-- Will be populated by debug.js -->
        </table>
    </div>
    
    <div class="debug-panel">
        <h2>System Information</h2>
        <pre id="system-info"></pre>
    </div>
    
    <div class="debug-panel">
        <h2>Console Output</h2>
        <pre id="console-log"></pre>
    </div>
    
    <div class="debug-panel">
        <h2>Manual Diagnostic Actions</h2>
        <button onclick="checkApiEndpoint('/api/data')">Test API Data</button>
        <button onclick="checkApiEndpoint('/api/config')">Test API Config</button>
        <button onclick="checkApiEndpoint('/api/wifi/status')">Test WiFi Status</button>
        <button onclick="testWebSocket()">Test WebSocket</button>
        <button onclick="testLocalStorage()">Test Local Storage</button>
    </div>
    
    <!-- Load debug.js script -->
    <script>
        // This must be defined before loading debug.js
        window.updateModuleStatus = function(module, status) {
            if (!window.moduleStatus) window.moduleStatus = {};
            window.moduleStatus[module] = status;
            
            // Update the module table if it exists
            const table = document.getElementById('module-table');
            if (!table) return;
            
            // Clear existing rows except header
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            
            // Add current status
            for (const [mod, stat] of Object.entries(window.moduleStatus)) {
                const row = table.insertRow();
                const moduleCell = row.insertCell(0);
                const statusCell = row.insertCell(1);
                
                moduleCell.textContent = mod;
                statusCell.textContent = stat ? '‚úÖ Loaded' : '‚ùå Failed';
                statusCell.className = stat ? 'status-ok' : 'status-error';
            }
        };
        
        // Notification from debug.js when it completes checks
        window.debugCheckComplete = function() {
            console.log("Debug.js DOM check complete");
            updateStatusMessage("Debug checks completed. DOM elements may be missing in standalone mode.");
        };
    </script>
    
    <!-- Now load debug.js -->
    <script src="debug.js"></script>
    
    <script>
        // Global variables
        let iframeMode = false;
        let iframeLoaded = false;
        let iframeLoadAttempts = 0;
        const maxLoadAttempts = 3;
        
        // Status message updates
        function updateStatusMessage(message) {
            const statusMessage = document.getElementById('status-message');
            if (statusMessage) {
                statusMessage.textContent = message;
            }
        }
        
        // Override console methods to capture logs
        (function() {
            const consoleLog = document.getElementById('console-log');
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function() {
                const args = Array.from(arguments);
                consoleLog.textContent += 'üìÑ LOG: ' + args.join(' ') + '\n';
                originalLog.apply(console, arguments);
            };
            
            console.error = function() {
                const args = Array.from(arguments);
                consoleLog.textContent += '‚ùå ERROR: ' + args.join(' ') + '\n';
                originalError.apply(console, arguments);
            };
            
            console.warn = function() {
                const args = Array.from(arguments);
                consoleLog.textContent += '‚ö†Ô∏è WARN: ' + args.join(' ') + '\n';
                originalWarn.apply(console, arguments);
            };
        })();
        
        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }
        
        // Clear console log
        function clearLog() {
            document.getElementById('console-log').textContent = '';
        }
        
        // Toggle between iframe and standalone mode with improved handling
        function toggleIframeMode(enable) {
            iframeMode = enable;
            const container = document.getElementById('iframe-container');
            const overlay = document.getElementById('iframe-overlay');
            
            if (enable) {
                // Show iframe container
                container.style.display = 'block';
                updateStatusMessage("Loading main application in iframe...");
                
                if (!iframeLoaded || iframeLoadAttempts < maxLoadAttempts) {
                    // Show loading overlay
                    if (overlay) overlay.style.display = 'flex';
                    
                    // Reset iframe by setting to about:blank first
                    const iframe = document.getElementById('app-iframe');
                    iframe.src = 'about:blank';
                    
                    // Wait a moment before loading the actual page
                    setTimeout(() => {
                        iframe.onload = function() {
                            console.log('Main app iframe loaded');
                            iframeLoaded = true;
                            iframeLoadAttempts++;
                            
                            // Hide loading overlay
                            if (overlay) overlay.style.display = 'none';
                            
                            // Wait for the iframe content to initialize
                            setTimeout(() => {
                                recheckElements();
                                updateStatusMessage("Main application loaded in iframe. Element checking is now active.");
                            }, 1000);
                        };
                        
                        // Set the source to index.html
                        iframe.src = 'index.html';
                    }, 100);
                } else {
                    // Hide loading overlay for previously loaded iframe
                    if (overlay) overlay.style.display = 'none';
                    recheckElements();
                }
            } else {
                // Hide iframe
                container.style.display = 'none';
                updateStatusMessage("Running in standalone mode. DOM elements will show as missing.");
                recheckElements();
            }
        }
        
        // Check DOM elements with improved error handling and verbose logging
        function recheckElements() {
            console.log(`Checking DOM elements in ${iframeMode ? 'iframe' : 'standalone'} mode`);
            
            // Clear existing rows
            const table = document.getElementById('elements-table');
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            
            // Get document context
            let docContext = document;
            let frameDoc = null;
            
            if (iframeMode && iframeLoaded) {
                try {
                    const iframe = document.getElementById('app-iframe');
                    if (iframe && iframe.contentDocument) {
                        frameDoc = iframe.contentDocument;
                        docContext = frameDoc;
                        console.log("Successfully accessed iframe document");
                    } else {
                        console.error("Iframe or contentDocument not available");
                    }
                } catch (e) {
                    console.error('Error accessing iframe content:', e);
                }
            }
            
            // List of elements to check
            const elementsToCheck = [
                'power-animation-container', 
                'psu-voltage', 
                'psu-current', 
                'psu-power',
                'output-status',
                'toggle-output',
                'theme-toggle',
                'configForm',
                'wifi-status',
                'dots-indicator'
            ];
            
            // Perform the checks
            let foundCount = 0;
            elementsToCheck.forEach(id => {
                let element = null;
                
                try {
                    element = docContext.getElementById(id);
                    if (element) foundCount++;
                } catch (e) {
                    console.error(`Error checking element ${id}:`, e);
                }
                
                const row = document.createElement('tr');
                
                const idCell = document.createElement('td');
                idCell.textContent = id;
                
                const statusCell = document.createElement('td');
                if (element) {
                    statusCell.textContent = '‚úÖ Found';
                    statusCell.className = 'status-ok';
                } else {
                    statusCell.textContent = '‚ùå Missing';
                    statusCell.className = 'status-error';
                    if (iframeMode) {
                        statusCell.textContent += ' (in iframe)';
                    } else {
                        statusCell.textContent += ' (standalone)';
                    }
                }
                
                row.appendChild(idCell);
                row.appendChild(statusCell);
                table.appendChild(row);
            });
            
            // Log summary
            if (iframeMode) {
                console.log(`DOM check complete: ${foundCount}/${elementsToCheck.length} elements found in iframe`);
                if (foundCount === 0) {
                    console.error("No elements found in iframe - this may indicate a cross-origin issue or iframe loading problem");
                    updateStatusMessage("Warning: No elements found in iframe. Try refreshing the page.");
                }
            } else {
                console.log(`DOM check complete: ${foundCount}/${elementsToCheck.length} elements found in standalone mode`);
            }
        }
        
        // Gather system information
        function gatherSystemInfo() {
            const info = document.getElementById('system-info');
            
            const systemInfo = {
                'User Agent': navigator.userAgent,
                'Screen Size': `${window.screen.width}x${window.screen.height}`,
                'Window Size': `${window.innerWidth}x${window.innerHeight}`,
                'Pixel Ratio': window.devicePixelRatio,
                'Language': navigator.language,
                'URL': window.location.href,
                'Protocol': window.location.protocol,
                'Cookies Enabled': navigator.cookieEnabled,
                'Local Storage Available': typeof Storage !== 'undefined',
                'Theme Preference': window.matchMedia('(prefers-color-scheme: dark)').matches ? 'Dark' : 'Light'
            };
            
            let infoText = '';
            for (const [key, value] of Object.entries(systemInfo)) {
                infoText += `${key}: ${value}\n`;
            }
            
            info.textContent = infoText;
        }
        
        // Test API endpoints
        function checkApiEndpoint(endpoint) {
            console.log(`Testing API endpoint: ${endpoint}`);
            fetch(endpoint)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`API ${endpoint} response:`, JSON.stringify(data, null, 2));
                })
                .catch(error => {
                    console.error(`API ${endpoint} error:`, error);
                });
        }
        
        // Test WebSocket connection
        function testWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
            
            console.log(`Testing WebSocket connection to ${wsUrl}`);
            
            try {
                const socket = new WebSocket(wsUrl);
                
                socket.onopen = function() {
                    console.log("WebSocket connection established successfully");
                    socket.send(JSON.stringify({ action: "getStatus" }));
                };
                
                socket.onmessage = function(event) {
                    console.log("WebSocket message received:", event.data);
                    socket.close();
                };
                
                socket.onerror = function(error) {
                    console.error("WebSocket error:", error);
                };
                
                socket.onclose = function() {
                    console.log("WebSocket connection closed");
                };
            } catch (error) {
                console.error("WebSocket connection failed:", error);
            }
        }
        
        // Test local storage
        function testLocalStorage() {
            try {
                localStorage.setItem('debug_test', 'working');
                const testValue = localStorage.getItem('debug_test');
                localStorage.removeItem('debug_test');
                
                if (testValue === 'working') {
                    console.log("Local Storage test: ‚úÖ Working correctly");
                } else {
                    console.log("Local Storage test: ‚ùå Value mismatch");
                }
            } catch (error) {
                console.error("Local Storage test: ‚ùå Error accessing localStorage", error);
            }
        }
        
        // Track loaded modules from debug.js
        window.moduleStatus = {};
        window.updateModuleStatus = function(module, status) {
            moduleStatus[module] = status;
            
            const table = document.getElementById('module-table');
            // Clear existing rows except header
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            
            // Add current status
            for (const [mod, stat] of Object.entries(moduleStatus)) {
                const row = table.insertRow();
                const moduleCell = row.insertCell(0);
                const statusCell = row.insertCell(1);
                
                moduleCell.textContent = mod;
                statusCell.textContent = stat ? '‚úÖ Loaded' : '‚ùå Failed';
                statusCell.className = stat ? 'status-ok' : 'status-error';
            }
        };
        
        // Run checks when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Debug diagnostic page loaded');
            console.log('Note: DOM elements check will show missing elements in standalone mode');
            console.log('Click "Load Main App in Frame" to check elements in the main application');
            
            checkDomElements();
            gatherSystemInfo();
            
            // Capture any modules already loaded
            if (typeof moduleFiles !== 'undefined') {
                moduleFiles.forEach(file => {
                    window.updateModuleStatus(file, false);
                });
            }
            
            // Add information about how to use the page
            console.log('');
            console.log('==== How to use this diagnostic page ====');
            console.log('1. Click "Load Main App in Frame" to check elements in the main application');
            console.log('2. If elements are still missing, try refreshing the page');
            console.log('3. Use the API test buttons to check backend connectivity');
            console.log('4. Check the module loading status table to see if JS modules loaded correctly');
            console.log('=======================================');
        });
    </script>
</body>
</html>
