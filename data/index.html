<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XY-SK120 120W DPS</title>
    <link rel="stylesheet" href="style.css">
    <!-- Add favicon and apple touch icon links -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">
    <!-- Add meta tags for better mobile experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="XY-SK120">
    <meta name="theme-color" content="#2c3e50" id="theme-color">
</head>
<body>
    <div class="container">
        <header>
            <h1>XY-SK120 120W DPS</h1>
            <div class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                <!-- Moon icon for light theme (shows when in light mode) -->
                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
                </svg>
                <!-- Sun icon for dark theme (shows when in dark mode) -->
                <svg class="sun-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0-5a1 1 0 0 0 1-1V1a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1zm0 19a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1zm10-10h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2zM4 12a1 1 0 0 0-1-1H2a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1zm16.95-7.05a1 1 0 0 0-1.41 0l-1 1a1 1 0 0 0 1.41 1.41l1-1a1 1 0 0 0 0-1.41zm-16.9 14.1a1 1 0 0 0-1.41 0l-1 1a1 1 0 0 0 1.41 1.41l1-1a1 1 0 0 0 0-1.41zm14.1 0a1 1 0 0 0 0 1.41l1 1a1 1 0 0 0 1.41-1.41l-1-1a1 1 0 0 0-1.41 0zm-16.1-14.1a1 1 0 0 0 0-1.41l-1-1a1 1 0 0 0-1.41 1.41l1 1a1 1 0 0 0 1.41 0z"/>
                </svg>
            </div>
            <p class="ip-display">Device IP: <span id="device-ip">--</span></p>
        </header>
        
        <!-- Power Supply Control Card -->
        <div class="card">
            <h2>Power Supply Control</h2>
            <div class="power-supply-control">
                <div class="output-status">
                    <div class="status-row">
                        <div class="status-label">Output Status:</div>
                        <div class="status-value" id="output-status">Unknown</div>
                    </div>
                    <button id="toggle-output" class="primary">Toggle Output</button>
                </div>
                
                <div class="control-settings">
                    <div class="readings">
                        <div class="reading-item">
                            <div class="reading-label">Voltage</div>
                            <div class="reading-value" id="psu-voltage">--</div>
                            <div class="reading-unit">V</div>
                        </div>
                        <div class="reading-item">
                            <div class="reading-label">Current</div>
                            <div class="reading-value" id="psu-current">--</div>
                            <div class="reading-unit">A</div>
                        </div>
                        <div class="reading-item">
                            <div class="reading-label">Power</div>
                            <div class="reading-value" id="psu-power">--</div>
                            <div class="reading-unit">W</div>
                        </div>
                    </div>
                    
                    <div class="control-inputs">
                        <div class="form-group">
                            <label for="set-voltage">Set Voltage (V)</label>
                            <div class="input-with-button">
                                <input type="number" id="set-voltage" min="0" max="30" step="0.1">
                                <button id="apply-voltage" class="secondary">Set</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="set-current">Set Current (A)</label>
                            <div class="input-with-button">
                                <input type="number" id="set-current" min="0" max="5" step="0.01">
                                <button id="apply-current" class="secondary">Set</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button id="refresh-psu" class="secondary">Refresh Status</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configuration Card -->
        <div class="card">
            <h2>Configuration</h2>
            <form id="configForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" name="deviceName">
                </div>
                
                <div class="form-group">
                    <label for="modbusId">Modbus ID</label>
                    <input type="number" id="modbusId" name="modbusId" min="1" max="247">
                </div>
                
                <div class="form-group">
                    <label for="baudRate">Baud Rate</label>
                    <select id="baudRate" name="baudRate">
                        <option value="4800">4800</option>
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dataBits">Data Bits</label>
                    <select id="dataBits" name="dataBits">
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="parity">Parity</label>
                    <select id="parity" name="parity">
                        <option value="0">None</option>
                        <option value="1">Odd</option>
                        <option value="2">Even</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="stopBits">Stop Bits</label>
                    <select id="stopBits" name="stopBits">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="updateInterval">Update Interval (ms)</label>
                    <input type="number" id="updateInterval" name="updateInterval" min="1000" max="60000">
                </div>
                
                <div class="button-group">
                    <button type="submit" class="primary">Save Configuration</button>
                    <button type="button" id="resetBtn">Reset Device</button>
                </div>
            </form>
        </div>
        
        <!-- WiFi Status card -->
        <div class="card">
            <h2>WiFi Status</h2>
            <div class="wifi-status">
                <div class="status-row">
                    <div class="status-label">Status:</div>
                    <div class="status-value" id="wifi-status">Unknown</div>
                </div>
                <div class="status-row">
                    <div class="status-label">SSID:</div>
                    <div class="status-value" id="wifi-ssid">--</div>
                </div>
                <div class="status-row">
                    <div class="status-label">IP Address:</div>
                    <div class="status-value" id="wifi-ip">--</div>
                </div>
                <div class="status-row">
                    <div class="status-label">Signal Strength:</div>
                    <div class="status-value" id="wifi-rssi">--</div>
                </div>
                <div class="button-group">
                    <button type="button" id="wifiResetBtn" class="danger">Reset WiFi Settings</button>
                    <button type="button" id="wifiRefreshBtn" class="secondary">Refresh Status</button>
                </div>
            </div>
        </div>
        
        <!-- Keep the dots indicator for mobile -->
        <div class="dots-indicator" id="dots-indicator">
            <div class="dot active" title="Power Supply"></div>
            <div class="dot" title="Configuration"></div>
            <div class="dot" title="WiFi Status"></div>
        </div>
    </div>
    
    <script src="main.js"></script>
    <script>
      // Backup script to ensure page loads even if main.js fails
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - checking if main script initialized');
        
        // Check if main.js loaded correctly after 2 seconds
        setTimeout(function() {
          const psuVoltage = document.getElementById('psu-voltage');
          if (psuVoltage && psuVoltage.textContent === '--') {
            console.log('Main script may not have loaded properly, manually fetching data');
            fetch('/api/data')
              .then(response => response.json())
              .then(data => {
                console.log('Backup fetch received data:', data);
                
                // Update power supply values
                const psuVoltage = document.getElementById('psu-voltage');
                const psuCurrent = document.getElementById('psu-current');
                const psuPower = document.getElementById('psu-power');
                const outputStatus = document.getElementById('output-status');
                
                if (psuVoltage && data.voltage !== undefined) {
                  psuVoltage.textContent = parseFloat(data.voltage).toFixed(2);
                }
                
                if (psuCurrent && data.current !== undefined) {
                  psuCurrent.textContent = parseFloat(data.current).toFixed(3);
                }
                
                if (psuPower && data.power !== undefined) {
                  psuPower.textContent = parseFloat(data.power).toFixed(1);
                }
                
                if (outputStatus && data.outputEnabled !== undefined) {
                  outputStatus.textContent = data.outputEnabled ? "ON" : "OFF";
                  outputStatus.className = data.outputEnabled ? "status-value on" : "status-value off";
                }
              })
              .catch(error => console.error('Backup fetch error:', error));
          }
        }, 2000);
      });

      // Add extra initialization for swipe functionality
      document.addEventListener('DOMContentLoaded', function() {
        // Add swipe debug helper
        function updateSwipeDebug(message) {
            const debug = document.getElementById('swipe-debug');
            if (debug) {
                debug.textContent = message;
            }
        }
        
        // Force refresh of swipe cards when orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                const container = document.getElementById('cards-container');
                if (container) {
                    // Force layout recalculation
                    container.style.display = 'none';
                    setTimeout(() => {
                        container.style.display = 'flex';
                        // Call initSwipeCards if it exists
                        if (typeof initSwipeCards === 'function') {
                            initSwipeCards();
                        }
                    }, 50);
                }
            }, 300);
        });
        
        // Enable debug mode with URL parameter ?debug=1
        if (window.location.search.includes('debug=1')) {
            document.getElementById('swipe-debug').style.display = 'block';
            
            // Listen for swipe events
            const container = document.getElementById('cards-container');
            if (container) {
                container.addEventListener('touchstart', () => updateSwipeDebug('Swipe started'));
                container.addEventListener('touchmove', (e) => updateSwipeDebug(`Swiping: ${e.touches[0].clientX}px`));
                container.addEventListener('touchend', () => updateSwipeDebug('Swipe ended'));
            }
        }
      });
    </script>
</body>
</html>
