<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XY-SK120 120W DPS</title>
    
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="css/tailwind.css">
    
    <!-- Favicon references -->
    <link rel="icon" href="favicon/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="XY-SK120">
    <meta name="theme-color" content="#2c3e50" id="theme-color">
    
    <!-- Main application script - load after DOM is ready -->
    <script type="module" src="main.js"></script>
</head>
<body class="bg-background dark:bg-background-dark h-full">
    <div class="max-w-4xl mx-auto p-4 sm:p-5 flex flex-col h-full">
        <!-- Header component -->
        <header class="mb-5">
            <div class="flex items-center justify-center w-full mb-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 min-w-12 mr-3 relative flex justify-center items-center">
                        <svg width="48" height="48" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full h-full overflow-visible">
                          <defs>
                            <linearGradient id="fill-color-gradient" x1="0.5" y1="0" x2="0.5" y2="1">
                              <stop offset="0.37" stop-color="#64ff00" stop-opacity="1"></stop>
                              <stop offset="0.65" stop-color="#fff500" stop-opacity="1"></stop>
                            </linearGradient>
                            <pattern id="fill-pattern" patternUnits="userSpaceOnUse" x="8" y="4" width="48" height="56" patternTransform="matrix(1.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000)">
                              <rect width="48" height="56" style="fill:url(#fill-color-gradient)"></rect>
                            </pattern>
                          </defs>
                          <path d="M38.973,4.253C39.777,4.701,40.172,5.638,39.931,6.525L34.619,26.000L54.000,26.000C54.797,26.000,55.517,26.473,55.834,27.203C56.152,27.934,56.005,28.783,55.461,29.365L27.461,59.365C26.834,60.039,25.827,60.197,25.023,59.749C24.219,59.300,23.825,58.360,24.069,57.472L29.381,38.000L10.000,38.000C9.203,38.000,8.483,37.527,8.166,36.797C7.848,36.066,7.995,35.217,8.539,34.635L36.539,4.635C37.166,3.963,38.171,3.806,38.973,4.253Z" 
                          fill="url(#fill-pattern)" 
                          stroke="#b73dff" 
                          stroke-width="1.5"
                          style="fill:url(#fill-pattern) !important; fill-opacity:1;"
                          ></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-primary dark:text-white truncate">XY-SK120 120W DPS</h1>
                </div>
            </div>
        </header>
        
        <!-- Readings display -->
        <div class="bg-card dark:bg-card-dark rounded-lg shadow p-4 mb-5">
            <div class="flex flex-wrap justify-around mb-2">
                <div class="text-center min-w-[75px] mb-1 w-1/3">
                    <div class="text-base text-text dark:text-text-dark opacity-70 mb-1">Voltage</div>
                    <div class="flex justify-center items-baseline">
                        <span class="text-4xl font-bold leading-tight text-voltage" id="psu-voltage">--</span>
                        <span class="text-4xl font-bold ml-0.5 text-voltage">V</span>
                    </div>
                </div>
                <div class="text-center min-w-[75px] mb-1 w-1/3">
                    <div class="text-base text-text dark:text-text-dark opacity-70 mb-1">Current</div>
                    <div class="flex justify-center items-baseline">
                        <span class="text-4xl font-bold leading-tight text-current" id="psu-current">--</span>
                        <span class="text-4xl font-bold ml-0.5 text-current">A</span>
                    </div>
                </div>
                <div class="text-center min-w-[75px] mb-1 w-1/3">
                    <div class="text-base text-text dark:text-text-dark opacity-70 mb-1">Power</div>
                    <div class="flex justify-center items-baseline">
                        <span class="text-4xl font-bold leading-tight text-power" id="psu-power">--</span>
                        <span class="text-4xl font-bold ml-0.5 text-power">W</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between py-2 mt-2 border-t border-border dark:border-border-dark">
                <div class="flex items-center">
                    <span class="font-bold mr-1 text-sm">Output:</span>
                    <span class="mr-2 text-sm" id="output-status">--</span>
                </div>
                <div class="flex-1 text-center">
                    <span id="operatingModeDisplay" class="font-bold text-sm bg-black/5 dark:bg-white/10 px-2 py-0.5 rounded">--</span>
                </div>
                <div class="flex items-center">
                    <!-- Fixed power switch -->
                    <div class="relative w-[50px] h-6 flex items-center justify-center">
                        <label class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="power-toggle" class="sr-only peer">
                            <div class="w-[50px] h-6 bg-gray-400 rounded-full peer peer-focus:ring-2 peer-focus:ring-secondary 
                                 peer-checked:bg-secondary transition-colors duration-300" id="power-slider">
                            </div>
                            <div class="absolute top-[2px] left-1 bg-white w-4 h-4 rounded-full transition-all duration-300
                                 peer-checked:left-[30px] shadow-md">
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Simple Tab Interface -->
        <div class="bg-card dark:bg-card-dark rounded-lg shadow flex flex-col h-full">
            <!-- Tab Navigation -->
            <div class="border-b border-border dark:border-border-dark">
                <div class="flex overflow-x-auto">
                    <button class="simple-tab py-3 px-4 font-medium border-b-2 border-secondary -mb-px text-primary dark:text-white" data-tab="basic">
                        Basic Control
                    </button>
                    <button class="simple-tab py-3 px-4 font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400" data-tab="operation">
                        Operation Modes
                    </button>
                    <button class="simple-tab py-3 px-4 font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400" data-tab="config">
                        Config
                    </button>
                    <button class="simple-tab py-3 px-4 font-medium border-b-2 border-transparent text-gray-500 dark:text-gray-400" data-tab="wifi">
                        WiFi Status
                    </button>
                </div>
            </div>
            
            <!-- Tab Content -->
            <div class="p-4 overflow-y-auto flex-1">
                <!-- Basic Control Tab -->
                <div id="tab-basic" class="tab-content">
                    <div class="mb-4">
                        <label for="set-voltage" class="block mb-1 font-medium text-sm">Set Voltage (V)</label>
                        <div class="flex items-stretch gap-2 w-full">
                            <input type="number" id="set-voltage" min="0" max="30" step="0.1" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" class="flex-1 h-input min-w-0">
                            <button id="apply-voltage" class="h-input whitespace-nowrap min-w-[80px] px-3 bg-gray-600 text-white">Set</button>
                        </div>
                    </div>
                    
                    <!-- Voltage presets -->
                    <div class="mb-4">
                        <button id="voltage-preset-btn" class="w-full bg-secondary text-white rounded flex items-center justify-between px-3 h-10">
                            Common Voltages
                            <span class="text-xs opacity-80 ml-2">Tap to select</span>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label for="set-current" class="block mb-1 font-medium text-sm">Set Current (A)</label>
                        <div class="flex items-stretch gap-2 w-full">
                            <input type="number" id="set-current" min="0" max="5" step="0.01" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" class="flex-1 h-input min-w-0">
                            <button id="apply-current" class="h-input whitespace-nowrap min-w-[80px] px-3 bg-gray-600 text-white">Set</button>
                        </div>
                    </div>
                    
                    <!-- Key lock control -->
                    <div class="mb-5">
                        <div class="flex items-center justify-between my-2 cursor-pointer">
                            <span class="text-sm font-bold flex-1">Front Panel Keys</span>
                            <div class="relative w-[50px] h-6 flex items-center justify-center">
                                <label class="inline-flex relative items-center cursor-pointer">
                                    <input type="checkbox" id="key-lock-checkbox" class="sr-only peer">
                                    <div class="w-[50px] h-6 bg-gray-400 rounded-full peer peer-focus:ring-2 peer-focus:ring-secondary 
                                         peer-checked:bg-secondary transition-colors duration-300">
                                    </div>
                                    <div class="absolute top-[2px] left-1 bg-white w-4 h-4 rounded-full transition-all duration-300
                                         peer-checked:left-[30px] shadow-md">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button id="refresh-psu" class="bg-gray-600 text-white h-10 px-4 rounded">Refresh</button>
                </div>
                
                <!-- Operation Mode Tab -->
                <div id="tab-operation" class="tab-content hidden">
                    <div class="flex border-b border-border dark:border-border-dark mb-4">
                        <!-- Mode tabs with specific color classes -->
                        <button class="flex-1 text-center py-2 cursor-pointer transition-all duration-300 border-b-2 border-secondary font-bold opacity-100 text-voltage mode-tab" data-mode="cv">
                            CV
                        </button>
                        <button class="flex-1 text-center py-2 cursor-pointer transition-all duration-300 border-b-2 border-transparent font-bold opacity-70 text-current mode-tab" data-mode="cc">
                            CC
                        </button>
                        <button class="flex-1 text-center py-2 cursor-pointer transition-all duration-300 border-b-2 border-transparent font-bold opacity-70 text-power mode-tab" data-mode="cp">
                            CP
                        </button>
                    </div>
                    
                    <!-- Mode content -->
                    <div>
                        <!-- CV settings -->
                        <div id="cv-settings" class="mode-settings py-2">
                            <div class="mb-3">
                                <label for="set-cv-voltage" class="block mb-1 font-medium text-sm">Constant Voltage (V)</label>
                                <div class="flex items-stretch gap-2 w-full">
                                    <input type="number" id="set-cv-voltage" min="0" max="30" step="0.1" inputmode="decimal" class="flex-1 h-input min-w-0">
                                    <button id="apply-cv" class="h-input whitespace-nowrap min-w-[80px] px-3 bg-gray-600 text-white">Apply</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- CC settings -->
                        <div id="cc-settings" class="mode-settings py-2 hidden">
                            <div class="mb-3">
                                <label for="set-cc-current" class="block mb-1 font-medium text-sm">Constant Current (A)</label>
                                <div class="flex items-stretch gap-2 w-full">
                                    <input type="number" id="set-cc-current" min="0" max="5" step="0.01" inputmode="decimal" class="flex-1 h-input min-w-0">
                                    <button id="apply-cc" class="h-input whitespace-nowrap min-w-[80px] px-3 bg-gray-600 text-white">Apply</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- CP settings -->
                        <div id="cp-settings" class="mode-settings py-2 hidden">
                            <div class="mb-3">
                                <label for="set-cp-power" class="block mb-1 font-medium text-sm">Constant Power (W)</label>
                                <div class="flex items-stretch gap-2 w-full">
                                    <input type="number" id="set-cp-power" min="0" max="120" step="0.5" inputmode="decimal" class="flex-1 h-input min-w-0">
                                    <button id="apply-cp" class="h-input whitespace-nowrap min-w-[80px] px-3 bg-gray-600 text-white">Apply</button>
                                </div>
                            </div>
                            
                            <div class="mb-1">
                                <label class="block mb-1 font-medium text-sm">CP Mode</label>
                                <div class="flex gap-2">
                                    <button id="cp-mode-on" class="flex-1 bg-success text-white h-10 rounded">Enable</button>
                                    <button id="cp-mode-off" class="flex-1 bg-danger text-white h-10 rounded">Disable</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Config Tab -->
                <div id="tab-config" class="tab-content hidden">
                    <!-- Theme toggle control -->
                    <div class="flex items-center mb-4 pb-3 border-b border-border dark:border-border-dark">
                        <label class="flex items-center cursor-pointer w-full" for="theme-checkbox">
                            <span class="text-sm font-bold flex-1">Dark Mode</span>
                            <div class="relative w-[50px] h-6 flex items-center justify-center">
                                <label class="inline-flex relative items-center cursor-pointer">
                                    <input type="checkbox" id="theme-checkbox" class="sr-only peer">
                                    <div class="w-[50px] h-6 bg-gray-400 rounded-full peer peer-focus:ring-2 peer-focus:ring-secondary 
                                         peer-checked:bg-secondary transition-colors duration-300">
                                    </div>
                                    <div class="absolute top-[2px] left-1 bg-white w-4 h-4 rounded-full transition-all duration-300
                                         peer-checked:left-[30px] shadow-md">
                                    </div>
                                </label>
                            </div>
                        </label>
                    </div>
                    
                    <form id="configForm">
                        <div class="mb-3">
                            <label for="deviceName" class="block mb-1 font-medium text-sm">Device Name</label>
                            <input type="text" id="deviceName" name="deviceName" class="w-full h-input px-3 py-2 border border-border dark:border-border-dark rounded">
                        </div>
                        
                        <div class="mb-3">
                            <label for="modbusId" class="block mb-1 font-medium text-sm">Modbus ID</label>
                            <input type="number" id="modbusId" name="modbusId" min="1" max="247" inputmode="numeric" pattern="[0-9]*" class="w-full h-input px-3 py-2 border border-border dark:border-border-dark rounded">
                        </div>
                        
                        <div class="flex justify-between gap-3 mb-5">
                            <button type="submit" class="flex-1 bg-secondary text-white h-10 rounded">Save</button>
                            <button type="button" id="resetBtn" class="flex-1 bg-gray-600 text-white h-10 rounded">Reset</button>
                        </div>
                    </form>
                    
                    <!-- Device Connection Configuration -->
                    <div class="border-t border-border dark:border-border-dark pt-4 mt-2">
                        <h3 class="text-lg font-bold mb-2">Device Connection</h3>
                        
                        <div class="flex items-center mb-3">
                            <div class="font-bold mr-1 w-24">Status:</div>
                            <div id="websocket-status" class="font-medium">Not Connected</div>
                        </div>
                        
                        <div class="flex items-center mb-3">
                            <div class="font-bold mr-1 w-24">Connected to:</div>
                            <div id="connected-device">--</div>
                        </div>
                        
                        <div id="connection-info-banner" class="mb-3 p-2 rounded bg-black/5 dark:bg-white/5 text-xs">
                          Enter your XIAO's IP address (e.g., 192.168.1.168) below to connect. 
                          After adding a device, it will automatically attempt to connect.
                        </div>
                        
                        <div class="mb-3">
                            <label for="device-selector" class="block mb-1 font-medium text-sm">Select Device</label>
                            <select id="device-selector" class="w-full mb-2 h-input px-3 py-2 border border-border dark:border-border-dark rounded"></select>
                        </div>
                        
                        <div class="flex justify-between gap-3 mb-4">
                            <button type="button" id="manage-devices-btn" class="flex-1 bg-secondary text-white h-10 rounded">
                                Manage Devices
                            </button>
                            <button type="button" id="reconnect-btn" class="flex-1 bg-gray-600 text-white h-10 rounded">
                                Reconnect
                            </button>
                        </div>
                        
                        <form id="add-device-form" class="flex flex-col gap-2 mt-3">
                          <div class="flex gap-2">
                            <input type="text" id="new-device-ip" placeholder="192.168.1.x" class="flex-1 h-input px-3 py-2 border border-border dark:border-border-dark rounded" required>
                            <input type="text" id="new-device-name" placeholder="Name (optional)" class="flex-1 h-input px-3 py-2 border border-border dark:border-border-dark rounded">
                          </div>
                          <button type="submit" class="bg-secondary text-white h-10 rounded font-bold">Add & Connect</button>
                        </form>
                    </div>
                </div>
                
                <!-- WiFi Status Tab -->
                <div id="tab-wifi" class="tab-content hidden">
                    <div class="flex items-center py-1 mb-2">
                        <div class="font-bold mr-1 w-20">Status:</div>
                        <div id="wifi-status" class="font-medium">Unknown</div>
                    </div>
                    
                    <div class="flex items-center py-1 mb-2">
                        <div class="font-bold mr-1 w-20">SSID:</div>
                        <div id="wifi-ssid">--</div>
                    </div>
                    
                    <div class="flex items-center py-1 mb-5">
                        <div class="font-bold mr-1 w-20">IP:</div>
                        <div id="wifi-ip">--</div>
                    </div>
                    
                    <div class="flex justify-between gap-3">
                        <button type="button" id="wifiResetBtn" class="flex-1 bg-danger text-white h-10 rounded">Reset WiFi</button>
                        <button type="button" id="wifiRefreshBtn" class="flex-1 bg-gray-600 text-white h-10 rounded">Refresh Status</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Popup for voltage selection -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-overlay hidden" id="voltage-overlay"></div>
    <div id="voltage-popup" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-card dark:bg-card-dark rounded-xl shadow-lg z-popup w-[85%] max-w-[280px] max-h-[60vh] overflow-hidden flex flex-col">
        <div class="text-center p-3 font-bold border-b border-border dark:border-border-dark bg-primary text-white rounded-t-xl">Select Voltage</div>
        <div class="overflow-y-auto flex-1">
            <div class="p-0 flex flex-col">
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="1.8">1.8V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="3.3">3.3V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="4.2">4.2V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="5">5V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="9">9V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="12">12V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="15">15V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 border-b border-border dark:border-border-dark" data-voltage="18">18V</div>
                <div class="h-10 flex items-center justify-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800" data-voltage="20">20V</div>
            </div>
        </div>
    </div>
    
    <!-- Simple tab switching script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get all tabs and content
            const tabs = document.querySelectorAll('.simple-tab');
            const contents = document.querySelectorAll('.tab-content');
            
            // Add click handler to each tab
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Update tab styling
                    tabs.forEach(t => {
                        t.classList.remove('border-secondary', 'text-primary', 'dark:text-white');
                        t.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                    });
                    
                    this.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                    this.classList.add('border-secondary', 'text-primary', 'dark:text-white');
                    
                    // Update content visibility
                    contents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    const activeContent = document.getElementById(`tab-${tabName}`);
                    if (activeContent) {
                        activeContent.classList.remove('hidden');
                    }
                });
            });
            
            // Set up operation mode tabs 
            const modeTabs = document.querySelectorAll('.mode-tab');
            const modeSettings = document.querySelectorAll('.mode-settings');
            
            modeTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    
                    // Update tab styling
                    modeTabs.forEach(t => {
                        t.classList.remove('border-secondary', 'opacity-100');
                        t.classList.add('border-transparent', 'opacity-70');
                    });
                    
                    this.classList.remove('border-transparent', 'opacity-70');
                    this.classList.add('border-secondary', 'opacity-100');
                    
                    // Update content visibility
                    modeSettings.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    const activeSettings = document.getElementById(`${mode}-settings`);
                    if (activeSettings) {
                        activeSettings.classList.remove('hidden');
                    }
                });
            });
            
            // Setup voltage preset popup
            const presetButton = document.getElementById('voltage-preset-btn');
            const popup = document.getElementById('voltage-popup');
            const overlay = document.getElementById('voltage-overlay');
            
            if (presetButton && popup && overlay) {
                presetButton.addEventListener('click', function() {
                    popup.classList.remove('hidden');
                    popup.classList.add('flex');
                    overlay.classList.remove('hidden');
                });
                
                overlay.addEventListener('click', function() {
                    popup.classList.add('hidden');
                    popup.classList.remove('flex');
                    overlay.classList.add('hidden');
                });
                
                const voltageOptions = popup.querySelectorAll('div[data-voltage]');
                voltageOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const voltage = this.getAttribute('data-voltage');
                        const voltageInput = document.getElementById('set-voltage');
                        
                        if (voltageInput && voltage) {
                            voltageInput.value = voltage;
                            
                            // Close popup
                            popup.classList.add('hidden');
                            popup.classList.remove('flex');
                            overlay.classList.add('hidden');
                        }
                    });
                });
            }
        });
    </script>
    <script src="fallback-api.js"></script>
    <script src="debug-tools.js"></script>
    <script src="device-controller.js"></script>
</body>
</html>