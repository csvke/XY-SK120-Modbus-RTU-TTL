<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XY-SK120 120W DPS</title>
    
    <!-- Black background before anything loads -->
    <style>
        html, body {
            background-color: #000000;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        
        /* Splash screen styles (must be included inline to prevent flash) */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            opacity: 0; /* Start invisible for fade-in effect */
        }
        .splash-screen.fade-in {
            opacity: 1;
        }
        .splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .splash-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            position: relative;
        }
        .splash-logo svg {
            width: 100%;
            height: 100%;
            fill: #3498db;
            stroke: #b73dff;
            stroke-width: 1.5;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .splash-text {
            color: white;
            font-family: Arial, sans-serif;
            font-size: 18px;
            text-align: center;
        }
        @media (prefers-color-scheme: dark) {
            .splash-screen { background-color: #121212; }
        }
        /* Hide main content initially */
        body > .container { opacity: 0; transition: opacity 0.5s ease-in; }
    </style>
    
    <!-- Regular stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    
    <!-- Add favicon and apple touch icon links -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">
    
    <!-- Add meta tags for better mobile experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="XY-SK120">
    <meta name="theme-color" content="#2c3e50" id="theme-color">

    <!-- Add this to the head section -->
    <script type="module" src="main.js"></script>
</head>
<body>
    <!-- Splash screen -->
    <div class="splash-screen" id="splash-screen">
        <div class="splash-logo">
            <svg width="64" xmlns="http://www.w3.org/2000/svg" height="64" viewBox="0 0 64 64" fill="none">
              <g style="fill: rgb(0, 0, 0);" class="frame-children">
                <defs>
                  <linearGradient id="splash-a" x1=".5" y1="0" x2=".5" y2="1">
                    <stop offset=".37" stop-color="#64ff00"/>
                    <stop offset=".65" stop-color="#fff500"/>
                  </linearGradient>
                  <pattern patternUnits="userSpaceOnUse" x="8" y="4" width="48" height="56.002" patternTransform="matrix(1.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000)" id="splash-b">
                    <rect width="48" height="56.002" style="fill: url(#splash-a);"/>
                  </pattern>
                </defs>
                <path d="M38.973,4.253C39.777,4.701,40.172,5.638,39.931,6.525L34.619,26.000L54.000,26.000C54.797,26.000,55.517,26.473,55.834,27.203C56.152,27.934,56.005,28.783,55.461,29.365L27.461,59.365C26.834,60.039,25.827,60.197,25.023,59.749C24.219,59.300,23.825,58.360,24.069,57.472L29.381,38.000L10.000,38.000C9.203,38.000,8.483,37.527,8.166,36.797C7.848,36.066,7.995,35.217,8.539,34.635L36.539,4.635C37.166,3.963,38.171,3.806,38.973,4.253Z" fill="url(#splash-b)" clip-rule="evenodd" fill-rule="evenodd" class="fills"/>
                <path d="M38.973,4.253C39.777,4.701,40.172,5.638,39.931,6.525L34.619,26.000L54.000,26.000C54.797,26.000,55.517,26.473,55.834,27.203C56.152,27.934,56.005,28.783,55.461,29.365L27.461,59.365C26.834,60.039,25.827,60.197,25.023,59.749C24.219,59.300,23.825,58.360,24.069,57.472L29.381,38.000L10.000,38.000C9.203,38.000,8.483,37.527,8.166,36.797C7.848,36.066,7.995,35.217,8.539,34.635L36.539,4.635C37.166,3.963,38.171,3.806,38.973,4.253Z" style="fill: none; stroke-width: 1.5; stroke: rgb(183, 61, 255); stroke-opacity: 1;" class="stroke-shape"/>
              </g>
            </svg>
        </div>
        <div class="spinner"></div>
        <div class="splash-text">Loading XY-SK120 Interface...</div>
    </div>
    
    <div class="container">
        <header>
            <div class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                <!-- Moon icon for light theme (shows when in light mode) -->
                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
                </svg>
                <!-- Sun icon for dark theme (shows when in dark mode) -->
                <svg class="sun-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0-5a1 1 0 0 0 1-1V1a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1zm0 19a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1zm10-10h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2zM4 12a1 1 0 0 0-1-1H2a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1zm16.95-7.05a1 1 0 0 0-1.41 0l-1 1a1 1 0 0 0 1.41 1.41l1-1a1 1 0 0 0 0-1.41zm-16.9 14.1a1 1 0 0 0-1.41 0l-1 1a1 1 0 0 0 1.41 1.41l1-1a1 1 0 0 0 0-1.41zm14.1 0a1 1 0 0 0 0 1.41l1 1a1 1 0 0 0 1.41-1.41l-1-1a1 1 0 0 0-1.41 0zm-16.1-14.1a1 1 0 0 0 0-1.41l-1-1a1 1 0 0 0-1.41 1.41l1 1a1 1 0 0 0 1.41 0z"/>
                </svg>
            </div>
            <div class="header-container">
                <div class="header-logo">
                    <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
                      <defs>
                        <linearGradient id="fill-color-gradient" x1="0.5" y1="0" x2="0.5" y2="1">
                          <stop offset="0.37" stop-color="#64ff00" stop-opacity="1"></stop>
                          <stop offset="0.65" stop-color="#fff500" stop-opacity="1"></stop>
                        </linearGradient>
                        <pattern id="fill-pattern" patternUnits="userSpaceOnUse" x="8" y="4" width="48" height="56" patternTransform="matrix(1.000000, 0.000000, 0.000000, 1.000000, 0.000000, 0.000000)">
                          <rect width="48" height="56" style="fill:url(#fill-color-gradient)"></rect>
                        </pattern>
                      </defs>
                      <path d="M38.973,4.253C39.777,4.701,40.172,5.638,39.931,6.525L34.619,26.000L54.000,26.000C54.797,26.000,55.517,26.473,55.834,27.203C56.152,27.934,56.005,28.783,55.461,29.365L27.461,59.365C26.834,60.039,25.827,60.197,25.023,59.749C24.219,59.300,23.825,58.360,24.069,57.472L29.381,38.000L10.000,38.000C9.203,38.000,8.483,37.527,8.166,36.797C7.848,36.066,7.995,35.217,8.539,34.635L36.539,4.635C37.166,3.963,38.171,3.806,38.973,4.253Z" 
                        fill="url(#fill-pattern)" 
                        stroke="#b73dff" 
                        stroke-width="1.5"
                        style="fill:url(#fill-pattern) !important; fill-opacity:1;"
                      ></path>
                    </svg>
                </div>
                <h1>XY-SK120 120W DPS</h1>
            </div>
        </header>
        
        <!-- Power Supply Control Card -->
        <div class="card">
            <h2>Power Supply Control</h2>
            <div class="power-supply-control">
                <div class="output-status">
                    <div class="status-row">
                        <div class="status-label">Output Status:</div>
                        <div class="status-value" id="output-status">Unknown</div>
                    </div>
                    <!-- Power button container remains unchanged -->
                    <div class="power-button-container">
                        <div id="power-animation-container"></div>
                    </div>
                </div>
                
                <div class="control-settings">
                    <div class="readings">
                        <div class="reading-item">
                            <div class="reading-label">Voltage</div>
                            <div class="reading-value" id="psu-voltage">--</div>
                            <div class="reading-unit">V</div>
                        </div>
                        <div class="reading-item">
                            <div class="reading-label">Current</div>
                            <div class="reading-value" id="psu-current">--</div>
                            <div class="reading-unit">A</div>
                        </div>
                        <div class="reading-item">
                            <div class="reading-label">Power</div>
                            <div class="reading-value" id="psu-power">--</div>
                            <div class="reading-unit">W</div>
                        </div>
                    </div>
                    
                    <div class="control-inputs">
                        <div class="form-group">
                            <label for="set-voltage">Set Voltage (V)</label>
                            <div class="input-with-button">
                                <input type="number" id="set-voltage" min="0" max="30" step="0.1" inputmode="decimal" pattern="[0-9]*\.?[0-9]*">
                                <button id="apply-voltage" class="secondary">Set</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="set-current">Set Current (A)</label>
                            <div class="input-with-button">
                                <input type="number" id="set-current" min="0" max="5" step="0.01" inputmode="decimal" pattern="[0-9]*\.?[0-9]*">
                                <button id="apply-current" class="secondary">Set</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button id="refresh-psu" class="secondary">Refresh Status</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configuration Card -->
        <div class="card">
            <h2>Configuration</h2>
            <form id="configForm">
                <div class="form-group">
                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" name="deviceName">
                </div>
                
                <div class="form-group">
                    <label for="modbusId">Modbus ID</label>
                    <input type="number" id="modbusId" name="modbusId" min="1" max="247" inputmode="numeric" pattern="[0-9]*">
                </div>
                
                <div class="form-group">
                    <label for="baudRate">Baud Rate</label>
                    <select id="baudRate" name="baudRate">
                        <option value="4800">4800</option>
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="dataBits">Data Bits</label>
                    <select id="dataBits" name="dataBits">
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="parity">Parity</label>
                    <select id="parity" name="parity">
                        <option value="0">None</option>
                        <option value="1">Odd</option>
                        <option value="2">Even</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="stopBits">Stop Bits</label>
                    <select id="stopBits" name="stopBits">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="updateInterval">Update Interval (ms)</label>
                    <input type="number" id="updateInterval" name="updateInterval" min="1000" max="60000" inputmode="numeric" pattern="[0-9]*">
                </div>
                
                <div class="button-group">
                    <button type="submit" class="primary">Save Configuration</button>
                    <button type="button" id="resetBtn">Reset Device</button>
                </div>
            </form>
        </div>
        
        <!-- WiFi Status card -->
        <div class="card">
            <h2>WiFi Status</h2>
            <div class="wifi-status">
                <div class="status-row">
                    <div class="status-label">Status:</div>
                    <div class="status-value" id="wifi-status">Unknown</div>
                </div>
                <div class="status-row">
                    <div class="status-label">SSID:</div>
                    <div class="status-value" id="wifi-ssid">--</div>
                </div>
                <div class="status-row">
                    <div class="status-label">IP Address:</div>
                    <div class="status-value" id="wifi-ip">--</div>
                </div>
                <div class="status-row">
                    <div class="status-label">Signal Strength:</div>
                    <div class="status-value" id="wifi-rssi">--</div>
                </div>
                <div class="button-group">
                    <button type="button" id="wifiResetBtn" class="danger">Reset WiFi Settings</button>
                    <button type="button" id="wifiRefreshBtn" class="secondary">Refresh Status</button>
                </div>
            </div>
        </div>
        
        <!-- Keep the dots indicator for mobile -->
        <div class="dots-indicator" id="dots-indicator">
            <div class="dot active" title="Power Supply"></div>
            <div class="dot" title="Configuration"></div>
            <div class="dot" title="WiFi Status"></div>
        </div>
    </div>
    
    <!-- Remove the old script tag for main.js if it exists -->
    
    <!-- Splash screen handling script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const splashScreen = document.getElementById('splash-screen');
            const container = document.querySelector('.container');
            
            // Track start time for minimum display duration
            const startTime = Date.now();
            const minDisplayTime = 1500; // 1.5 seconds minimum
            
            // Fade in splash screen immediately
            setTimeout(function() {
                splashScreen.classList.add('fade-in');
            }, 10);
            
            // Function to check if all resources are loaded
            const checkResourcesLoaded = function() {
                // Calculate how long the splash has been displayed
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
                
                if (document.readyState === 'complete') {
                    // Wait for minimum display time before fading out
                    setTimeout(function() {
                        // Show main content with fade-in
                        container.style.opacity = '1';
                        
                        // Hide splash screen
                        splashScreen.classList.remove('fade-in');
                        splashScreen.classList.add('fade-out');
                        
                        // Remove splash after animation completes
                        setTimeout(function() {
                            splashScreen.style.display = 'none';
                        }, 500);
                    }, remainingTime);
                    
                    // Remove listener
                    window.removeEventListener('load', checkResourcesLoaded);
                }
            };
            
            // Listen for window load event
            window.addEventListener('load', checkResourcesLoaded);
            
            // Fallback to hide splash screen after 8 seconds (longer than before)
            setTimeout(function() {
                container.style.opacity = '1';
                splashScreen.classList.remove('fade-in');
                splashScreen.classList.add('fade-out');
                setTimeout(function() {
                    splashScreen.style.display = 'none';
                }, 500);
            }, 8000);
        });
    </script>
    
    <script>
      // Backup script to ensure page loads even if main.js fails
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - checking if main script initialized');
        
        // Check if main.js loaded correctly after 2 seconds
        setTimeout(function() {
          const psuVoltage = document.getElementById('psu-voltage');
          if (psuVoltage && psuVoltage.textContent === '--') {
            console.log('Main script may not have loaded properly, manually fetching data');
            fetch('/api/data')
              .then(response => response.json())
              .then(data => {
                console.log('Backup fetch received data:', data);
                
                // Update power supply values
                const psuVoltage = document.getElementById('psu-voltage');
                const psuCurrent = document.getElementById('psu-current');
                const psuPower = document.getElementById('psu-power');
                const outputStatus = document.getElementById('output-status');
                
                if (psuVoltage && data.voltage !== undefined) {
                  psuVoltage.textContent = parseFloat(data.voltage).toFixed(2);
                }
                
                if (psuCurrent && data.current !== undefined) {
                  psuCurrent.textContent = parseFloat(data.current).toFixed(3);
                }
                
                if (psuPower && data.power !== undefined) {
                  psuPower.textContent = parseFloat(data.power).toFixed(1);
                }
                
                if (outputStatus && data.outputEnabled !== undefined) {
                  outputStatus.textContent = data.outputEnabled ? "ON" : "OFF";
                  outputStatus.className = data.outputEnabled ? "status-value on" : "status-value off";
                }
              })
              .catch(error => console.error('Backup fetch error:', error));
          }
        }, 2000);
      });

      // Add extra initialization for swipe functionality
      document.addEventListener('DOMContentLoaded', function() {
        // Add swipe debug helper
        function updateSwipeDebug(message) {
            const debug = document.getElementById('swipe-debug');
            if (debug) {
                debug.textContent = message;
            }
        }
        
        // Force refresh of swipe cards when orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                const container = document.getElementById('cards-container');
                if (container) {
                    // Force layout recalculation
                    container.style.display = 'none';
                    setTimeout(() => {
                        container.style.display = 'flex';
                        // Call initSwipeCards if it exists
                        if (typeof initSwipeCards === 'function') {
                            initSwipeCards();
                        }
                    }, 50);
                }
            }, 300);
        });
        
        // Enable debug mode with URL parameter ?debug=1
        if (window.location.search.includes('debug=1')) {
            document.getElementById('swipe-debug').style.display = 'block';
            
            // Listen for swipe events
            const container = document.getElementById('cards-container');
            if (container) {
                container.addEventListener('touchstart', () => updateSwipeDebug('Swipe started'));
                container.addEventListener('touchmove', (e) => updateSwipeDebug(`Swiping: ${e.touches[0].clientX}px`));
                container.addEventListener('touchend', () => updateSwipeDebug('Swipe ended'));
            }
        }
      });
    </script>

    <!-- Additional scripts at the end of the body element for swipe optimization -->
    <script>
    // Add touch optimization for iOS devices
    document.addEventListener('DOMContentLoaded', function() {
      // iOS smooth scrolling fixes
      const touchSmoothScrollFix = () => {
        document.addEventListener('touchmove', function(e) {
          // Only prevent default if body has swiping class
          if (document.body.classList.contains('swiping') && e.cancelable) {
            e.preventDefault();
          }
        }, { passive: false });
        
        // iOS rubber-band effect fix for modal views
        document.addEventListener('touchstart', function(e) {
          // Allow normal scrolling inside cards
          if (e.target.closest('.card') && !document.body.classList.contains('swiping')) {
            return;
          }
        }, { passive: true });
      };
      
      // Add momentum scrolling for safari
      const addMomentumScrollingForCards = () => {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
          card.style.WebkitOverflowScrolling = 'touch';
        });
      };
      
      // Detect iOS devices
      const iOSDevice = (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      if (iOSDevice) {
        touchSmoothScrollFix();
        addMomentumScrollingForCards();
      }
      
      // Add "active" state for buttons to improve touch feedback
      const buttons = document.querySelectorAll('button');
      buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
          this.classList.add('touch-active');
        });
        
        button.addEventListener('touchend', function() {
          this.classList.remove('touch-active');
        });
        
        button.addEventListener('touchcancel', function() {
          this.classList.remove('touch-active');
        });
      });
    });
    </script>
    <!-- Add debug script at the end of body -->
    <script src="debug.js"></script>
    <script src="mobileFix.js"></script>
</body>
</html>
